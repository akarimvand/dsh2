<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAPRA Dashboard (Material Theme)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px;}
        ::-webkit-scrollbar-track { background: #1e293b; /* slate-800 */ }
        ::-webkit-scrollbar-thumb { background: #475569; /* slate-600 */ border-radius: 4px;}
        ::-webkit-scrollbar-thumb:hover { background: #64748b; /* slate-500 */ }

        .tree-node.selected {
            background-color: rgba(56, 189, 248, 0.1); /* sky-400 with 10% opacity */
            color: #38bdf8; /* sky-400 */
            font-weight: 500;
        }
        .tree-node .chevron-toggle {
             transition: transform 0.2s ease-in-out;
        }
        .tree-node.open > div > .chevron-toggle, .tree-node.open > .bi-chevron-right {
            transform: rotate(90deg);
        }
        .tree-children {
            display: none;
        }
        .tree-node.open > .tree-children {
            display: block;
        }

        /* Gradient Card Animations */
        .gradient-card {
            transition: transform 0.4s cubic-bezier(.4,2,.6,1), box-shadow 0.4s ease, border-radius 0.4s ease;
            will-change: transform;
        }
        .gradient-card:hover {
            transform: perspective(600px) translateY(8px) scale(1.03) rotateX(10deg);
            box-shadow: 0 12px 24px rgba(0,0,0,0.3) !important;
            border-radius: 1.5rem 0.5rem 1.5rem 0.5rem/1.5rem 1.5rem 0.5rem 0.5rem;
        }
        .slogan-animation {
            animation: sloganAnimation 10s ease-in-out infinite alternate;
        }
        @keyframes sloganAnimation {
            0% { transform: translateY(0); opacity: 1; }
            50% { transform: translateY(-3px); opacity: 0.9; }
            100% { transform: translateY(0); opacity: 1; }
        }

        /* Ensure Bootstrap nav-tabs active state gets Tailwind accent */
        .nav-tabs .nav-link.active {
            border-color: #374151 #374151 #111827 !important; /* slate-700 slate-700 slate-900 (or card bg) */
            border-bottom: 3px solid #38bdf8 !important; /* sky-400 */
            color: #38bdf8 !important; /* sky-400 */
            background-color: transparent; /* or match card bg if needed */
        }
        .nav-tabs .nav-link {
            color: #9ca3af; /* slate-400 */
            border-bottom-width: 3px;
            border-bottom-color: transparent;
        }
        .nav-tabs .nav-link:hover {
            color: #e5e7eb; /* slate-200 */
            border-bottom-color: #4b5563; /* slate-600 */
        }
        .chart-container {
            height: 288px; /* h-72 */
            position: relative;
        }
        .table th, .table td {
            white-space: nowrap;
        }
        /* Styling for contact info hover from original CSS */
        .contact-info-interactive {
             transition: transform 0.4s cubic-bezier(.4,2,.6,1);
             will-change: transform;
        }
         /* Styling for dashboard title hover from original CSS */
        .dashboard-title-interactive {
             transition: transform 0.4s cubic-bezier(.4,2,.6,1);
             will-change: transform;
        }
        /* Clickable cursors */
        .clickable-count, .clickable-cell, .clickable-badge { cursor: pointer; }

        /* Loader animation (copied from original) */
        .sapra-loader svg { display: block; margin: 0 auto; }
        .sapra-loader circle:first-of-type {
            stroke: #38bdf8; /* sky-400 */
            animation: spin 1s linear infinite;
        }
        .sapra-loader circle:last-of-type {
            stroke: #475569; /* slate-600 */
            animation: spinRev 1.2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); stroke-dashoffset: 31.4; }
            50% { stroke-dashoffset: 0; }
            100% { transform: rotate(360deg); stroke-dashoffset: 31.4; }
        }
        @keyframes spinRev {
            0% { transform: rotate(360deg); stroke-dashoffset: 18.8; }
            50% { stroke-dashoffset: 0; }
            100% { transform: rotate(0deg); stroke-dashoffset: 18.8; }
        }

    </style>
</head>
<body class="bg-slate-900 text-slate-200 font-roboto">

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed top-0 left-0 h-full w-72 lg:w-80 bg-slate-800 text-slate-300 p-0 flex flex-col transition-transform duration-300 ease-in-out z-50 transform -translate-x-full lg:translate-x-0 print:hidden" role="complementary">
        <div class="p-6 text-center border-b border-slate-700 mb-4">
            <div class="flex items-center justify-center">
                 <a href="SAPRABOT.HTML" target="_blank" rel="noopener noreferrer"> <!-- Assuming SAPRABOT.HTML is a relevant link -->
                    <img src="SAPRA_WHITE-100.png" alt="SAPRA Logo" class="h-24 mx-auto mb-2 contact-info-interactive"> <!-- Added contact-info-interactive for hover -->
                </a>
            </div>
            <p class="text-sm slogan-animation text-slate-100">Smart Access to Project Activities</p>
        </div>

        <div class="px-6 mb-4">
            <div class="relative">
                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400">
                    <i class="bi bi-search"></i>
                </span>
                <input type="text" id="searchInput" class="w-full bg-slate-700 border border-slate-600 text-slate-200 placeholder-slate-500 text-sm rounded-md pl-10 pr-4 py-2 focus:ring-sky-500 focus:border-sky-500" placeholder="Search system...">
            </div>
        </div>

        <div id="treeView" class="flex-grow overflow-y-auto px-2 pb-4" role="tree" aria-label="System and Subsystem Navigation">
            <!-- Tree nodes will be injected here by JavaScript -->
        </div>

        <footer class="p-6 mt-auto border-t border-slate-700 text-center text-xs text-slate-500">
            <p class="font-semibold text-slate-200 mb-0">Developed by Amin Naseri</p>
            <p class="mb-0 contact-info-interactive text-slate-400 hover:text-sky-400 cursor-pointer">Contact Email: akarimvand@gmail.com</p>
            <p class="mb-0 contact-info-interactive text-slate-400 hover:text-sky-400 cursor-pointer">Contact Phone: +989366302800</p>
        </footer>
    </aside>
    <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-40 hidden lg:hidden print:hidden"></div>

    <!-- Main Content -->
    <div id="mainContent" class="lg:ml-80 transition-all duration-300 ease-in-out">
        <nav class="sticky top-0 bg-slate-800 shadow-md p-4 z-30 print:hidden">
            <div class="container-fluid mx-auto flex items-center justify-between">
                <button id="sidebarToggle" class="lg:hidden text-slate-200 hover:text-sky-400" aria-controls="sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation">
                    <i class="bi bi-list text-2xl"></i>
                </button>
                <div id="dashboardTitleContainer" class="text-center lg:text-left flex-grow">
                     <h5 class="text-lg font-semibold text-slate-100 mb-0 dashboard-title-interactive" id="dashboardTitle">Dashboard</h5>
                </div>
                <div class="flex items-center space-x-3">
                    <button id="exportExcelBtn" class="bg-green-600 hover:bg-green-700 text-white text-sm font-medium py-2 px-3 rounded-md flex items-center">
                        <i class="bi bi-file-earmark-excel mr-1.5"></i> Export to Excel
                    </button>
                    <span class="bg-sky-500 text-white text-xs font-semibold px-2.5 py-1.5 rounded-full flex items-center clickable-badge" id="totalItemsBadge">
                        <i class="bi bi-box-seam mr-1.5"></i>
                        <span id="totalItemsCounter">0</span>&nbsp;items
                    </span>
                </div>
            </div>
        </nav>

        <main class="container-fluid mx-auto p-4 md:p-6" role="main">
            <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                Error loading data.
            </div>

            <!-- Row 1: FORM A-D Cards -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-4 md:mb-6" id="summaryCardsRow2">
                <!-- FORM cards will be injected here -->
            </div>

            <!-- Row 2: Original Summary Cards + Issues Card -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-4 md:mb-6" id="summaryCardsRow1">
                <!-- Summary cards will be injected here -->
            </div>

            <!-- Charts Section -->
            <div class="bg-slate-800 shadow-lg rounded-xl p-4 md:p-6 mb-4 md:mb-6">
                <ul class="nav nav-tabs mb-4" id="chartTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active py-2 px-4" id="overview-tab-btn" data-bs-toggle="tab" data-bs-target="#overviewChartsContainer" data-tab-name="Overview" type="button" role="tab" aria-controls="overviewChartsContainer" aria-selected="true">Overview</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link py-2 px-4" id="bydiscipline-tab-btn" data-bs-toggle="tab" data-bs-target="#disciplineChartsContainer" data-tab-name="By Discipline" type="button" role="tab" aria-controls="disciplineChartsContainer" aria-selected="false">By Discipline</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link py-2 px-4" id="bysystem-tab-btn" data-bs-toggle="tab" data-bs-target="#systemChartsContainer" data-tab-name="By System" type="button" role="tab" aria-controls="systemChartsContainer" aria-selected="false">By System</button>
                    </li>
                </ul>
                <div class="tab-content pt-3">
                    <div id="overviewChartsContainer" class="tab-pane fade show active chart-tab-content" role="tabpanel" aria-labelledby="overview-tab-btn">
                         <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
                            <div>
                                <h6 class="text-slate-400 mb-2 text-center font-medium">General Status</h6>
                                <div class="chart-container"><canvas id="overviewChart" role="img" aria-label="General status doughnut chart"></canvas></div>
                            </div>
                            <div>
                                <h6 class="text-slate-400 mb-2 text-center font-medium">Issue Distribution</h6>
                                <div class="chart-container"><canvas id="issuesChart" role="img" aria-label="Issue distribution pie chart"></canvas></div>
                            </div>
                        </div>
                    </div>
                    <div id="disciplineChartsContainer" class="tab-pane fade chart-tab-content" role="tabpanel" aria-labelledby="bydiscipline-tab-btn">
                        <!-- Discipline charts will be injected here -->
                    </div>
                    <div id="systemChartsContainer" class="tab-pane fade chart-tab-content" role="tabpanel" aria-labelledby="bysystem-tab-btn">
                        <!-- System/Subsystem charts will be injected here -->
                    </div>
                </div>
            </div>

            <!-- Data Table -->
            <div class="bg-slate-800 shadow-lg rounded-xl p-4 md:p-6">
                <h5 class="text-xl font-semibold text-slate-300 mb-4">Items Details</h5>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-slate-400" id="dataTable" aria-live="polite">
                        <caption class="sr-only">Detailed item data based on current selection</caption>
                        <thead class="text-xs text-slate-300 uppercase bg-slate-700" id="dataTableHead">
                            <!-- Table headers will be injected here -->
                        </thead>
                        <tbody id="dataTableBody">
                            <!-- Table rows will be injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" aria-labelledby="loadingModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-slate-800 text-slate-200 shadow-xl rounded-lg">
          <div class="modal-body flex flex-col items-center justify-center p-6" style="min-height:180px;">
            <div class="sapra-loader mb-4">
              <svg width="48" height="48" viewBox="0 0 48 48">
                <circle cx="24" cy="24" r="20" fill="none" stroke-width="4" stroke-linecap="round" stroke-dasharray="31.4 31.4" stroke-dashoffset="0"></circle>
                <circle cx="24" cy="24" r="12" fill="none" stroke-width="4" stroke-linecap="round" stroke-dasharray="18.8 18.8" stroke-dashoffset="0"></circle>
              </svg>
            </div>
            <div id="loadingModalLabel" class="font-semibold text-sky-400 mb-1">Loading data...</div>
            <div class="text-slate-400 text-sm">Please wait a moment.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Item Details Modal -->
    <div class="modal fade" id="itemDetailsModal" tabindex="-1" aria-labelledby="itemDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content bg-slate-800 text-slate-200 shadow-xl rounded-lg">
                <div class="modal-header border-b border-slate-700 p-4">
                    <h5 class="modal-title text-lg font-semibold" id="itemDetailsModalLabel">Item Details</h5>
                    <button type="button" class="text-slate-400 hover:text-slate-100" data-bs-dismiss="modal" aria-label="Close">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
                <div class="modal-body p-4 md:p-6">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-400">
                            <thead class="text-xs text-slate-300 uppercase bg-slate-700">
                                <tr id="itemDetailsModalTableHead">
                                    <!-- Headers will be set by JS -->
                                </tr>
                            </thead>
                            <tbody id="itemDetailsTableBody" class="divide-y divide-slate-700">
                                <!-- Item details will be injected here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="noDetailsMessage" class="text-center text-slate-500 py-8 hidden">No matching items found.</div>
                </div>
                <div class="modal-footer border-t border-slate-700 p-4 flex justify-between items-center">
                    <button type="button" class="bg-green-600 hover:bg-green-700 text-white text-sm font-medium py-2 px-3 rounded-md flex items-center" id="exportDetailsExcelBtn">
                         <i class="bi bi-file-earmark-excel mr-1.5"></i> Export Visible to Excel
                     </button>
                    <button type="button" class="bg-slate-600 hover:bg-slate-500 text-slate-100 text-sm font-medium py-2 px-3 rounded-md" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

    <script>
        // --- Constants ---
        const CSV_URL = "https://raw.githubusercontent.com/akarimvand/SAPRA2/refs/heads/main/DATA.CSV";
        const ITEMS_CSV_URL = "https://raw.githubusercontent.com/akarimvand/SAPRA2/refs/heads/main/ITEMS.CSV";
        const PUNCH_CSV_URL = "https://raw.githubusercontent.com/akarimvand/SAPRA2/refs/heads/main/PUNCH.CSV";
        const HOLD_POINT_CSV_URL = "https://raw.githubusercontent.com/akarimvand/SAPRA2/refs/heads/main/HOLD_POINT.CSV";

        const COLORS_STATUS_CHARTJS = { // Using Tailwind-like colors for consistency if possible, or Chart.js compatible rgba
            done: 'rgba(74, 222, 128, 0.8)',    // green-400
            pending: 'rgba(251, 191, 36, 0.8)', // amber-400
            remaining: 'rgba(96, 165, 250, 0.8)' // blue-400
        };
        const COLORS_ISSUES_CHARTJS = {
            punch: 'rgba(248, 113, 113, 0.8)',   // red-400
            hold: 'rgba(167, 139, 250, 0.8)'    // violet-400
        };
        const ICONS = {
             Collection: '<i class="bi bi-collection text-sky-400" aria-hidden="true"></i>',
             Folder: '<i class="bi bi-folder-fill text-sky-400" aria-hidden="true"></i>',
             Puzzle: '<i class="bi bi-puzzle-fill text-sky-400" aria-hidden="true"></i>',
             ChevronRight: '<i class="bi bi-chevron-right chevron-toggle" aria-hidden="true"></i>',
             CheckCircle: '<i class="bi bi-check-circle-fill text-xl" aria-hidden="true"></i>', // Larger icons for cards
             Clock: '<i class="bi bi-clock-fill text-xl" aria-hidden="true"></i>',
             ArrowRepeat: '<i class="bi bi-arrow-repeat text-xl" aria-hidden="true"></i>',
             ExclamationTriangle: '<i class="bi bi-exclamation-triangle-fill text-xl" aria-hidden="true"></i>',
             FileEarmarkText: '<i class="bi bi-file-earmark-text-fill text-3xl" aria-hidden="true"></i>',
             FileEarmarkCheck: '<i class="bi bi-file-earmark-check-fill text-3xl" aria-hidden="true"></i>',
             FileEarmarkMedical: '<i class="bi bi-file-earmark-medical-fill text-3xl" aria-hidden="true"></i>',
             FileEarmarkSpreadsheet: '<i class="bi bi-file-earmark-spreadsheet-fill text-3xl" aria-hidden="true"></i>',
             PieChartIcon: '<i class="bi bi-pie-chart-fill text-5xl text-slate-500" aria-hidden="true"></i>'
        };

        // --- Global State ---
        let processedData = { systemMap: {}, subSystemMap: {}, allRawData: [] };
        let selectedView = { type: 'all', id: 'all', name: 'All Systems', parentId: null };
        let searchTerm = '';
        let activeChartTab = 'Overview';
        let aggregatedStats = { totalItems: 0, done: 0, pending: 0, punch: 0, hold: 0, remaining: 0 };
        let detailedItemsData = [];
        let punchItemsData = [];
        let holdPointItemsData = [];
        let displayedItemsInModal = [];
        let currentModalDataType = null;

        const chartInstances = { overview: null, issues: null, disciplines: {}, systems: {} };
        let bootstrapTabObjects = {};
        let itemDetailsModalInstance, loadingModalInstance;

        // --- DOM Elements ---
        const DOMElements = {
            sidebar: document.getElementById('sidebar'),
            sidebarToggle: document.getElementById('sidebarToggle'),
            sidebarOverlay: document.getElementById('sidebarOverlay'),
            mainContent: document.getElementById('mainContent'),
            treeView: document.getElementById('treeView'),
            searchInput: document.getElementById('searchInput'),
            dashboardTitle: document.getElementById('dashboardTitle'),
            totalItemsCounter: document.getElementById('totalItemsCounter'),
            totalItemsBadge: document.getElementById('totalItemsBadge'),
            summaryCardsRow1: document.getElementById('summaryCardsRow1'),
            summaryCardsRow2: document.getElementById('summaryCardsRow2'),
            chartTabs: document.getElementById('chartTabs'),
            overviewChartsContainer: document.getElementById('overviewChartsContainer'),
            disciplineChartsContainer: document.getElementById('disciplineChartsContainer'),
            systemChartsContainer: document.getElementById('systemChartsContainer'),
            dataTableHead: document.getElementById('dataTableHead'),
            dataTableBody: document.getElementById('dataTableBody'),
            exportExcelBtn: document.getElementById('exportExcelBtn'),
            errorMessage: document.getElementById('errorMessage'),
            itemDetailsModalTableHead: document.getElementById('itemDetailsModalTableHead'),
            itemDetailsTableBody: document.getElementById('itemDetailsTableBody'),
            noDetailsMessage: document.getElementById('noDetailsMessage'),
            exportDetailsExcelBtn: document.getElementById('exportDetailsExcelBtn'),
            loadingModal: document.getElementById('loadingModal'),
            itemDetailsModal: document.getElementById('itemDetailsModal'),
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initBootstrapComponents();
            initEventListeners();
            loadAndProcessData();
            DOMElements.sidebarToggle.setAttribute('aria-expanded', 'false');
        });

        function initBootstrapComponents() {
            DOMElements.chartTabs.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tabEl => {
                 bootstrapTabObjects[tabEl.id] = new bootstrap.Tab(tabEl);
            });
            itemDetailsModalInstance = new bootstrap.Modal(DOMElements.itemDetailsModal);
            loadingModalInstance = new bootstrap.Modal(DOMElements.loadingModal);
        }

        function initEventListeners() {
            DOMElements.sidebarToggle.addEventListener('click', () => {
                const isOpen = DOMElements.sidebar.classList.contains('lg:translate-x-0');
                if (DOMElements.sidebar.classList.contains('-translate-x-full')) {
                    DOMElements.sidebar.classList.remove('-translate-x-full');
                    DOMElements.sidebar.classList.add('translate-x-0');
                    DOMElements.sidebarOverlay.classList.remove('hidden');
                    DOMElements.sidebarToggle.setAttribute('aria-expanded', 'true');
                } else {
                    DOMElements.sidebar.classList.add('-translate-x-full');
                    DOMElements.sidebar.classList.remove('translate-x-0');
                    DOMElements.sidebarOverlay.classList.add('hidden');
                    DOMElements.sidebarToggle.setAttribute('aria-expanded', 'false');
                }
            });
            DOMElements.sidebarOverlay.addEventListener('click', () => {
                DOMElements.sidebar.classList.add('-translate-x-full');
                DOMElements.sidebar.classList.remove('translate-x-0');
                DOMElements.sidebarOverlay.classList.add('hidden');
                DOMElements.sidebarToggle.setAttribute('aria-expanded', 'false');
            });

            DOMElements.searchInput.addEventListener('input', (e) => {
                searchTerm = e.target.value.toLowerCase();
                renderSidebar();
            });
            DOMElements.searchInput.setAttribute('aria-label', 'Search system or subsystem');

            DOMElements.exportExcelBtn.addEventListener('click', handleExport);
            DOMElements.exportDetailsExcelBtn.addEventListener('click', handleDetailsExport);
            
            DOMElements.chartTabs.addEventListener('shown.bs.tab', (event) => { // Use Bootstrap event for tab changes
                const tabName = event.target.dataset.tabName;
                if (tabName && tabName !== activeChartTab) {
                    activeChartTab = tabName;
                    renderCharts();
                }
            });
            
            document.addEventListener('click', handleDetailsClick); // For summary cards, table cells
            DOMElements.totalItemsBadge.addEventListener('click', () => {
                 if (detailedItemsData.length > 0) {
                     const filteredItems = filterDetailedItems({ type: 'summary', status: 'TOTAL' });
                    populateDetailsModal(filteredItems, { type: 'summary', status: 'TOTAL' }, 'items');
                    itemDetailsModalInstance.show();
                } else {
                    alert("Detailed item data not loaded yet.");
                }
            });

            // Hover effects for logo, contact info, dashboard title (from original template)
            document.querySelectorAll('.contact-info-interactive, .dashboard-title-interactive, .sidebar-header img').forEach(el => {
                el.addEventListener('mousemove', function(e) {
                    const rect = this.getBoundingClientRect();
                    const y = e.clientY - rect.top;
                    const x = e.clientX - rect.left;
                    const percentY = y / rect.height;
                    const percentX = x / rect.width;
                    const maxTiltY = (this.tagName === 'IMG' || this.id === 'dashboardTitle') ? 15 : 10;
                    const maxTiltX = (this.tagName === 'IMG' || this.id === 'dashboardTitle') ? 10 : 5;
                    const tiltX = -percentY * maxTiltY + (maxTiltY / 2);
                    const tiltY = percentX * maxTiltX - (maxTiltX / 2);
                    this.style.transform = \`perspective(600px) rotateX(\${tiltX}deg) rotateY(\${tiltY}deg) scale(1.02)\`;
                });
                el.addEventListener('mouseleave', function() {
                    this.style.transform = '';
                });
            });
        }

        function handleDetailsClick(e) {
            let target = e.target.closest('.clickable-count, .clickable-cell, .clickable-badge');
            if (!target) return;

            let statusType = target.dataset.statusType;
            let filterContextType = target.dataset.contextType;
            let dataType = target.dataset.dataType || 'items'; // Default to 'items'

            if (!statusType || !filterContextType) return;

            let filterContext;
            if (filterContextType === 'summary') {
                filterContext = { type: 'summary', status: statusType };
            } else if (filterContextType === 'table') {
                const rowElement = target.closest('tr');
                if (!rowElement) return;
                const rowData = JSON.parse(rowElement.dataset.rowData || '{}');
                filterContext = { type: 'table', rowData: rowData, status: statusType };
            } else {
                return;
            }
            
            let dataToDisplay = [];
            let dataLoaded = false;

            if (dataType === 'items') {
                 if (detailedItemsData.length > 0) { dataToDisplay = filterDetailedItems(filterContext); dataLoaded = true; }
            } else if (dataType === 'punch') {
                 if (punchItemsData.length > 0) { dataToDisplay = filterPunchItems(filterContext); dataLoaded = true; }
            } else if (dataType === 'hold') {
                 if (holdPointItemsData.length > 0) { dataToDisplay = filterHoldItems(filterContext); dataLoaded = true; }
            }

            if (dataLoaded) {
                populateDetailsModal(dataToDisplay, filterContext, dataType);
                itemDetailsModalInstance.show();
            } else {
                alert(\`\${dataType.charAt(0).toUpperCase() + dataType.slice(1)} data not available or empty for this selection.\`);
            }
        }

        function generateModalTitle(baseTitle, context, dataTypeSuffix = "Items") {
            let title = baseTitle;
            if (context.type === 'summary') {
                if (selectedView.type === 'system' && selectedView.id) {
                    title += \` in System: \${selectedView.name}\`;
                } else if (selectedView.type === 'subsystem' && selectedView.id) {
                    title += \` in Subsystem: \${selectedView.name}\`;
                } else {
                    title += \` (All Systems)\`;
                }
            } else if (context.type === 'table') {
                title += \` in \${context.rowData.subsystem.split(' - ')[0]} / \${context.rowData.discipline}\`;
            }
            return \`\${title} \${dataTypeSuffix}\`;
        }
        
        function filterDetailedItems(context) {
            let filtered = detailedItemsData;
            let baseTitle = context.status === 'DONE' ? 'Completed' : context.status === 'PENDING' ? 'Pending' : context.status === 'TOTAL' ? 'Total' : 'Remaining';
        
            if (context.type === 'summary') {
                if (selectedView.type === 'system' && selectedView.id) {
                    const subSystemIds = processedData.systemMap[selectedView.id]?.subs.map(sub => sub.id.toLowerCase()) || [];
                    filtered = filtered.filter(item => item.subsystem && subSystemIds.includes(item.subsystem.toLowerCase()));
                } else if (selectedView.type === 'subsystem' && selectedView.id) {
                    filtered = filtered.filter(item => item.subsystem && item.subsystem.toLowerCase() === selectedView.id.toLowerCase());
                }
            } else if (context.type === 'table') {
                const clickedSubsystem = context.rowData.subsystem.split(' - ')[0].toLowerCase();
                const clickedDiscipline = context.rowData.discipline.toLowerCase();
                filtered = filtered.filter(item =>
                    item.subsystem && item.subsystem.toLowerCase() === clickedSubsystem &&
                    item.discipline && item.discipline.toLowerCase() === clickedDiscipline
                );
            }
        
            if (context.status !== 'TOTAL') {
                if (context.status === 'OTHER') {
                    filtered = filtered.filter(item => !item.status || (item.status.toLowerCase() !== 'done' && item.status.toLowerCase() !== 'pending'));
                } else {
                    filtered = filtered.filter(item => item.status && item.status.toLowerCase() === context.status.toLowerCase());
                }
            }
            document.getElementById('itemDetailsModalLabel').textContent = generateModalTitle(baseTitle, context);
            return filtered;
        }
        
        function filterPunchItems(context) {
            let filtered = punchItemsData;
            let baseTitle = 'Punch';
            if (context.type === 'summary') {
                if (selectedView.type === 'system' && selectedView.id) {
                    const subSystemIds = processedData.systemMap[selectedView.id]?.subs.map(sub => sub.id.toLowerCase()) || [];
                    filtered = filtered.filter(item => item.subsystem && subSystemIds.includes(item.subsystem.toLowerCase()));
                } else if (selectedView.type === 'subsystem' && selectedView.id) {
                    filtered = filtered.filter(item => item.subsystem && item.subsystem.toLowerCase() === selectedView.id.toLowerCase());
                }
            } else if (context.type === 'table') {
                const clickedSubsystem = context.rowData.subsystem.split(' - ')[0].toLowerCase();
                const clickedDiscipline = context.rowData.discipline.toLowerCase();
                filtered = filtered.filter(item =>
                    item.subsystem && item.subsystem.toLowerCase() === clickedSubsystem &&
                    item.discipline && item.discipline.toLowerCase() === clickedDiscipline
                );
            }
            document.getElementById('itemDetailsModalLabel').textContent = generateModalTitle(baseTitle, context, "Items");
            return filtered;
        }
        
        function filterHoldItems(context) {
            let filtered = holdPointItemsData;
            let baseTitle = 'Hold Point';
            if (context.type === 'summary') {
                if (selectedView.type === 'system' && selectedView.id) {
                    const subSystemIds = processedData.systemMap[selectedView.id]?.subs.map(sub => sub.id.toLowerCase()) || [];
                    filtered = filtered.filter(item => item.subsystem && subSystemIds.includes(item.subsystem.toLowerCase()));
                } else if (selectedView.type === 'subsystem' && selectedView.id) {
                    filtered = filtered.filter(item => item.subsystem && item.subsystem.toLowerCase() === selectedView.id.toLowerCase());
                }
            } else if (context.type === 'table') {
                const clickedSubsystem = context.rowData.subsystem.split(' - ')[0].toLowerCase();
                const clickedDiscipline = context.rowData.discipline.toLowerCase();
                filtered = filtered.filter(item =>
                    item.subsystem && item.subsystem.toLowerCase() === clickedSubsystem &&
                    item.discipline && item.discipline.toLowerCase() === clickedDiscipline
                );
            }
            document.getElementById('itemDetailsModalLabel').textContent = generateModalTitle(baseTitle, context, "Items");
            return filtered;
        }

        function populateDetailsModal(items, context, dataType) {
            DOMElements.itemDetailsTableBody.innerHTML = '';
            displayedItemsInModal = items;
            currentModalDataType = dataType;

            let headers = [];
            if (dataType === 'items') {
                headers = ['#', 'Subsystem', 'Discipline', 'Tag No', 'Type', 'Description', 'Status'];
            } else if (dataType === 'punch') {
                headers = ['#', 'Subsystem', 'Discipline', 'Tag No', 'Type', 'Category', 'Description'];
            } else if (dataType === 'hold') {
                headers = ['#', 'Subsystem', 'Discipline', 'Tag No', 'Type', 'HP Priority', 'HP Description', 'HP Location'];
            }
            DOMElements.itemDetailsModalTableHead.innerHTML = headers.map(h => \`<th scope="col" class="px-4 py-3">\${h}</th>\`).join('');

            if (items.length === 0) {
                DOMElements.noDetailsMessage.classList.remove('hidden');
            } else {
                DOMElements.noDetailsMessage.classList.add('hidden');
                items.forEach((item, index) => {
                    const row = DOMElements.itemDetailsTableBody.insertRow();
                    row.className = 'hover:bg-slate-700/50';
                    let cells = [];
                    if (dataType === 'items') {
                        cells = [index + 1, item.subsystem, item.discipline, item.tagNo, item.typeCode, item.description, item.status];
                         if(item.status && item.status.toLowerCase() === 'done') row.classList.add('text-green-400');
                         if(item.status && item.status.toLowerCase() === 'pending') row.classList.add('text-amber-400');
                    } else if (dataType === 'punch') {
                        cells = [index + 1, item.subsystem, item.discipline, item.tagNo, item.typeCode || 'N/A', item.punchCategory, item.punchDescription];
                        if (item.punchCategory) {
                            switch (item.punchCategory.toLowerCase()) {
                                case 'a': row.classList.add('text-red-400', 'font-semibold'); break;
                                case 'b': row.classList.add('text-sky-400'); break;
                                case 'c': row.classList.add('text-green-400'); break;
                            }
                        }
                    } else if (dataType === 'hold') {
                        cells = [index + 1, item.subsystem, item.discipline, item.tagNo, item.typeCode || 'N/A', item.hpPriority || 'N/A', item.hpDescription || 'N/A', item.hpLocation || 'N/A'];
                        // Potentially add classes for HP priority here
                    }
                    cells.forEach(cellData => {
                        const cell = row.insertCell();
                        cell.textContent = cellData;
                        cell.className = 'px-4 py-2';
                    });
                });
            }
        }
        
        async function loadAndProcessData() {
            loadingModalInstance.show();
            DOMElements.errorMessage.classList.add('hidden');
            try {
                const [mainCsvText, itemsCsvText, punchCsvText, holdCsvText] = await Promise.all([
                    fetch(CSV_URL).then(res => res.ok ? res.text() : Promise.reject(new Error(\`Failed to load main CSV: \${res.statusText}\`))),
                    fetch(ITEMS_CSV_URL).then(res => res.ok ? res.text() : Promise.reject(new Error(\`Failed to load items CSV: \${res.statusText}\`))),
                    fetch(PUNCH_CSV_URL).then(res => res.ok ? res.text() : Promise.reject(new Error(\`Failed to load punch CSV: \${res.statusText}\`))),
                    fetch(HOLD_POINT_CSV_URL).then(res => res.ok ? res.text() : Promise.reject(new Error(\`Failed to load hold point CSV: \${res.statusText}\`)))
                ]);

                const mainDataResults = Papa.parse(mainCsvText, { header: true, skipEmptyLines: true });
                const systemMap = {}; const subSystemMap = {};
                mainDataResults.data.forEach(row => {
                    if (!row.SD_System || !row.SD_Sub_System || !row.discipline) return;
                    const systemId = row.SD_System.trim();
                    const systemName = (row.SD_System_Name || 'Unknown System').trim();
                    const subId = row.SD_Sub_System.trim();
                    const subName = (row.SD_Subsystem_Name || 'Unknown Subsystem').trim();
                    const discipline = row.discipline.trim();

                    if (!systemMap[systemId]) systemMap[systemId] = { id: systemId, name: systemName, subs: [] };
                    if (!systemMap[systemId].subs.find(s => s.id === subId)) systemMap[systemId].subs.push({ id: subId, name: subName });
                    if (!subSystemMap[subId]) subSystemMap[subId] = { id: subId, name: subName, systemId: systemId, title: \`\${subId} - \${subName}\`, disciplines: {} };
                    
                    subSystemMap[subId].disciplines[discipline] = {
                        total: parseInt(row["TOTAL ITEM"]) || 0, done: parseInt(row["TOTAL DONE"]) || 0,
                        pending: parseInt(row["TOTAL PENDING"]) || 0, punch: parseInt(row["TOTAL NOT CLEAR PUNCH"]) || 0,
                        hold: parseInt(row["TOTAL HOLD POINT"]) || 0, remaining: Math.max(0, (parseInt(row["TOTAL ITEM"]) || 0) - (parseInt(row["TOTAL DONE"]) || 0) - (parseInt(row["TOTAL PENDING"]) || 0))
                    };
                });
                processedData = { systemMap, subSystemMap, allRawData: mainDataResults.data };

                detailedItemsData = Papa.parse(itemsCsvText, { header: true, skipEmptyLines: true }).data.map(item => ({
                    subsystem: item.SD_Sub_System?.trim() || '', discipline: item.Discipline_Name?.trim() || '',
                    tagNo: item.ITEM_Tag_NO?.trim() || '', typeCode: item.ITEM_Type_Code?.trim() || '',
                    description: item.ITEM_Description?.trim() || '', status: item.ITEM_Status?.trim() || ''
                }));
                punchItemsData = Papa.parse(punchCsvText, { header: true, skipEmptyLines: true }).data.map(item => ({
                    subsystem: item.SD_SUB_SYSTEM?.trim() || '', discipline: item.Discipline_Name?.trim() || '',
                    tagNo: item.ITEM_Tag_NO?.trim() || '', typeCode: item.ITEM_Type_Code?.trim() || '',
                    punchCategory: item.PL_Punch_Category?.trim() || '', punchDescription: item.PL_Punch_Description?.trim() || ''
                }));
                holdPointItemsData = Papa.parse(holdCsvText, { header: true, skipEmptyLines: true }).data.map(item => ({
                    subsystem: item.SD_SUB_SYSTEM?.trim() || '', discipline: item.Discipline_Name?.trim() || '',
                    tagNo: item.ITEM_Tag_NO?.trim() || '', typeCode: item.ITEM_Type_Code?.trim() || '',
                    hpPriority: item.HP_Priority?.trim() || '', hpDescription: item.HP_Description?.trim() || '',
                    hpLocation: item.HP_Location?.trim() || ''
                }));
                
                updateView();
            } catch (e) {
                DOMElements.errorMessage.textContent = \`Error fetching data: \${e.message}\`;
                DOMElements.errorMessage.classList.remove('hidden');
                console.error("Data loading/processing error:", e);
            } finally {
                setTimeout(() => { loadingModalInstance.hide(); }, 500); // Ensure loader stays for a bit
            }
        }

        function renderSidebar() {
            let html = '';
            const createNodeHTML = (node, level = 0, parentId = null) => {
                const isSelected = selectedView.type === node.type && selectedView.id === node.id;
                const hasChildren = node.children && node.children.length > 0;
                let childrenHTML = '';
                let isOpen = node.isOpen || false;
                 // Auto-open parent if a child is selected or if search term matches a child
                if (isSelected && parentId) { // if this node is selected and it's a child, ensure its parent is open
                    const parentNodeInTree = Object.values(processedData.systemMap).find(sys => sys.id === parentId);
                    if(parentNodeInTree) parentNodeInTree.isOpen = true; // A bit hacky, assumes treeData is updated elsewhere or this is for initial render
                }
                if (searchTerm && node.children?.some(child => child.name.toLowerCase().includes(searchTerm))) {
                    isOpen = true;
                }
                if (hasChildren) {
                    childrenHTML = \`<div class="tree-children ml-4 pl-2 border-l border-slate-700" role="group" style="display: \${isOpen ? 'block' : 'none'};">\${node.children.map(child => createNodeHTML(child, level + 1, node.id)).join('')}</div>\`;
                }

                const nodeId = \`tree-node-\${node.type}-\${node.id.replace(/[^a-zA-Z0-9-_]/g, '')}\`;
                let nameContent = node.name;
                if (node.type === 'system' && processedData.systemMap[node.id]) {
                    nameContent += \`<div class='text-xs text-slate-500'>\${processedData.systemMap[node.id].name}</div>\`;
                } else if (node.type === 'subsystem' && processedData.subSystemMap[node.id]) {
                     nameContent += \`<div class='text-xs text-slate-500'>\${processedData.subSystemMap[node.id].name}</div>\`;
                }

                return \`
                    <div id="\${nodeId}" class="tree-node flex items-center justify-between p-2 my-0.5 rounded-md cursor-pointer hover:bg-slate-700 \${isSelected ? 'selected' : ''} \${isOpen ? 'open' : ''}" 
                         role="treeitem" aria-selected="\${isSelected}" \${hasChildren ? \`aria-expanded="\${isOpen}"\` : ''}
                         data-type="\${node.type}" data-id="\${node.id}" data-name="\${node.name}" 
                         data-parent-id="\${parentId || ''}" tabindex="0">
                        <div class="flex items-center space-x-2">
                            \${node.icon || ''}
                            <span class="flex-grow text-sm">\${nameContent}</span>
                        </div>
                        \${hasChildren ? ICONS.ChevronRight : ''}
                    </div>
                    \${childrenHTML}
                \`;
            };

            const treeNodesConfig = [ { id: 'all', name: 'All Systems', type: 'all', icon: ICONS.Collection, isOpen: selectedView.id === 'all' } ];
            Object.values(processedData.systemMap).forEach(system => {
                const systemIsSelectedOrParentOfSelected = selectedView.id === system.id || selectedView.parentId === system.id;
                const systemContainsSearchedChild = searchTerm && system.subs.some(s => s.id.toLowerCase().includes(searchTerm));
                treeNodesConfig.push({
                    id: system.id, name: system.id, type: 'system', icon: ICONS.Folder,
                    isOpen: systemIsSelectedOrParentOfSelected || systemContainsSearchedChild,
                    children: system.subs.map(sub => ({
                        id: sub.id, name: sub.id, type: 'subsystem', icon: ICONS.Puzzle, parentId: system.id,
                        isOpen: selectedView.id === sub.id
                    }))
                });
            });
            
            const filterNodes = (nodes) => {
                if (!searchTerm) return nodes;
                return nodes.map(node => {
                    const isMatch = node.name.toLowerCase().includes(searchTerm) || (node.type === 'system' && processedData.systemMap[node.id]?.name.toLowerCase().includes(searchTerm)) || (node.type === 'subsystem' && processedData.subSystemMap[node.id]?.name.toLowerCase().includes(searchTerm));
                    const filteredChildren = node.children ? filterNodes(node.children) : null;
                    if (isMatch || (filteredChildren && filteredChildren.length > 0)) {
                        return { ...node, children: filteredChildren, isOpen: true }; 
                    }
                    return null;
                }).filter(Boolean);
            };
            
            const finalTreeNodes = filterNodes(treeNodesConfig);
            html = finalTreeNodes.map(node => createNodeHTML(node)).join('');
            if (finalTreeNodes.length === 0 && searchTerm) {
                html = \`<p class="text-slate-500 text-center text-sm p-3">No matching items found.</p>\`;
            }
            DOMElements.treeView.innerHTML = html;
            attachSidebarEventListeners();
        }
        
        function attachSidebarEventListeners() {
            DOMElements.treeView.querySelectorAll('.tree-node').forEach(el => {
                el.addEventListener('click', function(e) {
                    e.stopPropagation(); // Stop propagation to prevent multiple triggers if icons are nested
                    const type = this.dataset.type;
                    const id = this.dataset.id;
                    const name = this.dataset.name; // This is usually the ID, actual name comes from processedData
                    const parentId = this.dataset.parentId;
        
                    const targetIsChevron = e.target.classList.contains('chevron-toggle') || e.target.closest('.chevron-toggle') || e.target.classList.contains('bi-chevron-right');
                    const hasChildren = this.querySelector('.chevron-toggle, .bi-chevron-right') !== null;
        
                    if (targetIsChevron && hasChildren) { // Toggle children
                        const isOpen = this.classList.toggle('open');
                        this.setAttribute('aria-expanded', isOpen);
                        const childrenContainer = this.nextElementSibling;
                        if (childrenContainer && childrenContainer.classList.contains('tree-children')) {
                            childrenContainer.style.display = isOpen ? 'block' : 'none';
                        }
                    } else { // Select node
                        let displayName = name; // Default to ID
                        if (type === 'system' && processedData.systemMap[id]) displayName = processedData.systemMap[id].name;
                        else if (type === 'subsystem' && processedData.subSystemMap[id]) displayName = processedData.subSystemMap[id].name;
                        else if (type === 'all') displayName = 'All Systems';

                        handleNodeSelect(type, id, displayName, parentId); // Pass the correct display name
                        if (window.innerWidth < 1024) { // lg breakpoint in Tailwind
                            DOMElements.sidebar.classList.add('-translate-x-full');
                            DOMElements.sidebar.classList.remove('translate-x-0');
                            DOMElements.sidebarOverlay.classList.add('hidden');
                            DOMElements.sidebarToggle.setAttribute('aria-expanded', 'false');
                        }
                    }
                });
                el.addEventListener('keydown', function(e) { // Add keyboard navigation
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        this.click(); // Simulate click
                    }
                });
            });
        }

        function handleNodeSelect(type, id, name, parentId = null) {
            selectedView = { type, id, name, parentId }; 
            updateView();
        }
        
        function updateView() {
            aggregatedStats = _aggregateStatsForView(selectedView, processedData.systemMap, processedData.subSystemMap);

            let titleText = 'Dashboard';
            if (selectedView.type === 'system' && selectedView.id) {
                const systemName = processedData.systemMap[selectedView.id]?.name || selectedView.name; // Use stored name from selection
                titleText = \`System: \${selectedView.id} - \${systemName}\`;
            } else if (selectedView.type === 'subsystem' && selectedView.id) {
                const parentSystem = processedData.systemMap[selectedView.parentId];
                const parentSystemDisplay = parentSystem ? \`\${parentSystem.id} - \${parentSystem.name}\` : selectedView.parentId;
                const subsystemName = processedData.subSystemMap[selectedView.id]?.name || selectedView.name; // Use stored name
                titleText = \`<div><div class="text-xs text-slate-400">System: \${parentSystemDisplay}</div>Subsystem: \${selectedView.id} - \${subsystemName}</div>\`;
            }
            DOMElements.dashboardTitle.innerHTML = titleText;
            DOMElements.totalItemsCounter.textContent = aggregatedStats.totalItems.toLocaleString();

            renderSummaryCards();
            renderCharts(); 
            renderDataTable();
            renderSidebar(); 
        }

        function renderSummaryCards() {
            let row1HTML = ''; // FORM cards
            let row2HTML = ''; // Original summary cards

            const formCardsData = [
                { title: 'FORM A', count: 2, gradientClass: 'bg-gradient-to-br from-blue-500 to-blue-700', icon: ICONS.FileEarmarkText, desc: 'Submitted for Mech. Completion Approval' },
                { title: 'FORM B', count: 0, gradientClass: 'bg-gradient-to-br from-green-500 to-green-700', icon: ICONS.FileEarmarkCheck, desc: 'Returned with Pre-Comm. Punches' },
                { title: 'FORM C', count: 0, gradientClass: 'bg-gradient-to-br from-amber-500 to-amber-700', icon: ICONS.FileEarmarkMedical, desc: 'Punches Cleared & Resubmitted' },
                { title: 'FORM D', count: 0, gradientClass: 'bg-gradient-to-br from-purple-500 to-purple-700', icon: ICONS.FileEarmarkSpreadsheet, desc: 'Final Approval & Handover' },
            ];
            formCardsData.forEach(card => {
                row1HTML += \`
                    <section class="gradient-card \${card.gradientClass} text-white shadow-lg rounded-xl p-4 flex flex-col justify-between min-h-[160px]" aria-labelledby="summary-title-\${card.title.toLowerCase().replace(' ','-')}">
                        <div>
                            <div class="flex justify-between items-start mb-2">
                                <h6 id="summary-title-\${card.title.toLowerCase().replace(' ','-')}" class="text-lg font-semibold">\${card.title}</h6>
                                <span class="bg-black/20 p-1.5 rounded-md">\${card.icon}</span>
                            </div>
                            <h3 class="text-4xl font-bold mb-1">\${card.count.toLocaleString()}</h3>
                        </div>
                        <small class="block mt-1 text-white/80 leading-tight">\${card.desc}</small>
                    </section>\`;
            });
            DOMElements.summaryCardsRow2.innerHTML = row1HTML;


            const originalCardsData = [
                { title: 'Completed', count: aggregatedStats.done, total: aggregatedStats.totalItems, icon: ICONS.CheckCircle, iconBg: 'bg-green-500/20', iconColor: 'text-green-400', progressColor: 'bg-green-500', countColor: 'text-green-400', statusType: 'DONE', dataType: 'items' },
                { title: 'Pending', count: aggregatedStats.pending, total: aggregatedStats.totalItems, icon: ICONS.Clock, iconBg: 'bg-amber-500/20', iconColor: 'text-amber-400', progressColor: 'bg-amber-500', countColor: 'text-amber-400', statusType: 'PENDING', dataType: 'items' },
                { title: 'Remaining', count: aggregatedStats.remaining, total: aggregatedStats.totalItems, icon: ICONS.ArrowRepeat, iconBg: 'bg-blue-500/20', iconColor: 'text-blue-400', progressColor: 'bg-blue-500', countColor: 'text-blue-400', statusType: 'OTHER', dataType: 'items' },
            ];

            originalCardsData.forEach(card => {
                const percentage = (card.total > 0 && card.count >= 0) ? Math.round((card.count / card.total) * 100) : 0;
                row2HTML += \`
                    <section class="bg-slate-800 shadow-lg rounded-xl p-4 flex flex-col justify-between min-h-[160px]" aria-labelledby="summary-title-\${card.title.toLowerCase()}">
                        <div>
                            <div class="flex justify-between items-start mb-2">
                                <h6 id="summary-title-\${card.title.toLowerCase()}" class="font-medium text-slate-400">\${card.title}</h6>
                                <span class="icon-wrapper \${card.iconBg} \${card.iconColor} p-1.5 rounded-md">\${card.icon}</span>
                            </div>
                            <h3 class="text-3xl font-bold \${card.countColor} mb-1 clickable-count" data-status-type="\${card.statusType}" data-context-type="summary" data-data-type="\${card.dataType}">\${card.count.toLocaleString()}</h3>
                        </div>
                        \${card.total > 0 ? \`
                        <div>
                            <div class="w-full bg-slate-700 rounded-full h-1.5 mt-2 mb-1">
                                <div class="\${card.progressColor} h-1.5 rounded-full" style="width: \${percentage}%" role="progressbar" aria-valuenow="\${percentage}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <p class="text-slate-500 text-xs mt-1 mb-0">\${percentage}% of total items</p>
                        </div>
                        \` : '<div style="height: 28px;"></div>'} 
                    </section>\`;
            });
            
            // Issues Card
            row2HTML += \`
                <section class="bg-slate-800 shadow-lg rounded-xl p-4 flex flex-col justify-between min-h-[160px]" aria-labelledby="summary-title-issues">
                    <div>
                        <div class="flex justify-between items-start mb-2">
                            <h6 id="summary-title-issues" class="font-medium text-slate-400">Issues</h6>
                            <span class="icon-wrapper bg-red-500/20 text-red-400 p-1.5 rounded-md">\${ICONS.ExclamationTriangle}</span>
                        </div>
                        <div class="grid grid-cols-2 gap-x-2">
                            <div>
                                <p class="text-xs text-slate-500 mb-0">Punch</p>
                                <h4 class="text-red-400 font-semibold text-2xl clickable-count" data-status-type="PUNCH" data-context-type="summary" data-data-type="punch">\${aggregatedStats.punch.toLocaleString()}</h4>
                            </div>
                            <div>
                                <p class="text-xs text-slate-500 mb-0">Hold Point</p>
                                <h4 class="text-violet-400 font-semibold text-2xl clickable-count" data-status-type="HOLD" data-context-type="summary" data-data-type="hold">\${aggregatedStats.hold.toLocaleString()}</h4>
                            </div>
                        </div>
                    </div>
                    <div style="height: 28px;"></div> <!-- Spacer to match other cards -->
                </section>\`;
            DOMElements.summaryCardsRow1.innerHTML = row2HTML;
        }

        function destroyChart(chartInstance) { if (chartInstance) chartInstance.destroy(); }
        
        function renderCharts() {
            destroyChart(chartInstances.overview);
            destroyChart(chartInstances.issues);
            Object.values(chartInstances.disciplines).forEach(destroyChart); chartInstances.disciplines = {};
            Object.values(chartInstances.systems).forEach(destroyChart); chartInstances.systems = {};

            const activeTabPane = DOMElements.chartTabs.querySelector('.tab-pane.active');
            if (!activeTabPane) return;

            if (activeTabPane.id === 'overviewChartsContainer') renderOverviewCharts();
            else if (activeTabPane.id === 'disciplineChartsContainer') renderDisciplineCharts();
            else if (activeTabPane.id === 'systemChartsContainer') renderSystemSubsystemCharts();
        }

        function renderOverviewCharts() {
            const overviewCtx = document.getElementById('overviewChart').getContext('2d');
            const overviewParent = document.getElementById('overviewChart').parentElement;
            overviewParent.innerHTML = '<canvas id="overviewChart" role="img" aria-label="General status doughnut chart"></canvas>'; // Reset

            if (aggregatedStats.totalItems === 0 || (aggregatedStats.done === 0 && aggregatedStats.pending === 0 && aggregatedStats.remaining === 0)) {
                 overviewParent.innerHTML += '<div class="absolute inset-0 flex items-center justify-center text-slate-500 text-sm p-5">No data for General Status.</div>';
            } else {
                chartInstances.overview = new Chart(document.getElementById('overviewChart').getContext('2d'), { type: 'doughnut', data: {
                    labels: ['Completed', 'Pending', 'Remaining'],
                    datasets: [{ label: 'General Status', data: [aggregatedStats.done, aggregatedStats.pending, aggregatedStats.remaining].filter(v=>v>=0), backgroundColor: [COLORS_STATUS_CHARTJS.done, COLORS_STATUS_CHARTJS.pending, COLORS_STATUS_CHARTJS.remaining], hoverOffset: 4,  borderWidth: 0 }]
                }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels:{color: '#9ca3af'} }, tooltip: { callbacks: { label: (c) => \`\${c.label}: \${c.formattedValue} (\${Math.round(c.parsed / aggregatedStats.totalItems * 100)}%)\` }}} }});
            }

            const issuesCtx = document.getElementById('issuesChart').getContext('2d');
            const issuesParent = document.getElementById('issuesChart').parentElement;
            issuesParent.innerHTML = '<canvas id="issuesChart" role="img" aria-label="Issue distribution pie chart"></canvas>'; // Reset

            if (aggregatedStats.punch === 0 && aggregatedStats.hold === 0) {
                  issuesParent.innerHTML += '<div class="absolute inset-0 flex items-center justify-center text-slate-500 text-sm p-5">No issues data.</div>';
            } else {
                const totalIssues = aggregatedStats.punch + aggregatedStats.hold;
                chartInstances.issues = new Chart(document.getElementById('issuesChart').getContext('2d'), { type: 'pie', data: {
                    labels: ['Punch', 'Hold Point'],
                    datasets: [{ label: 'Issues Distribution', data: [aggregatedStats.punch, aggregatedStats.hold].filter(v=>v>=0), backgroundColor: [COLORS_ISSUES_CHARTJS.punch, COLORS_ISSUES_CHARTJS.hold], hoverOffset: 4, borderWidth: 0 }]
                }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels:{color: '#9ca3af'} }, tooltip: { callbacks: { label: (c) => \`\${c.label}: \${c.formattedValue} (\${totalIssues > 0 ? Math.round(c.parsed / totalIssues * 100) : 0}%)\` }}} }});
            }
        }

        function renderDisciplineCharts() {
            const container = DOMElements.disciplineChartsContainer;
            container.innerHTML = ''; 

            if (selectedView.type !== 'subsystem' || !selectedView.id) {
                container.innerHTML = \`<div class="col-span-full text-center py-10 text-slate-500" role="status">\${ICONS.PieChartIcon}<p class="mt-2">Select a subsystem for discipline details.</p></div>\`; return;
            }
            const subSystem = processedData.subSystemMap[selectedView.id];
            if (!subSystem || Object.keys(subSystem.disciplines).length === 0) {
                container.innerHTML = \`<div class="col-span-full text-center py-10 text-slate-500" role="status">\${ICONS.PieChartIcon}<p class="mt-2">No discipline data for this subsystem.</p></div>\`; return;
            }

            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4';
            Object.entries(subSystem.disciplines).forEach(([name, data]) => {
                const chartId = \`disciplineChart-\${selectedView.id}-\${name.replace(/[^a-zA-Z0-9]/g, '-')}\`;
                const itemHTML = \`
                    <div class="bg-slate-700/50 rounded-lg p-3 text-center">
                        <h6 class="text-slate-300 text-sm font-medium mb-1 truncate" title="\${name}">\${name}</h6>
                        <p class="text-slate-500 text-xs mb-2">\${data.total.toLocaleString()} items</p>
                        <div class="chart-container" style="height: 200px;"><canvas id="\${chartId}" role="img"></canvas></div>
                    </div>\`;
                grid.innerHTML += itemHTML;
                
                setTimeout(() => { // Ensure canvas is in DOM
                    const canvas = document.getElementById(chartId);
                    if (!canvas) return;
                    if (data.total > 0) {
                        chartInstances.disciplines[chartId] = new Chart(canvas.getContext('2d'), { type: 'doughnut', data: {
                            labels: ['Completed', 'Pending', 'Remaining'],
                            datasets: [{ label: name, data: [data.done, data.pending, data.remaining], backgroundColor: [COLORS_STATUS_CHARTJS.done, COLORS_STATUS_CHARTJS.pending, COLORS_STATUS_CHARTJS.remaining], borderWidth:0 }]
                        }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'bottom', labels: { color: '#9ca3af', boxWidth:10, font: {size: 10}} }, tooltip: { callbacks: { label: (c) => \`\${c.label}: \${c.formattedValue} (\${data.total > 0 ? Math.round(c.parsed / data.total * 100) : 0}%)\`}}} } });
                    } else {
                         canvas.parentElement.innerHTML = '<div class="h-full flex items-center justify-center text-slate-500 text-xs p-5">No data.</div>';
                    }
                }, 0);
            });
            container.appendChild(grid);
        }

        function renderSystemSubsystemCharts() {
            const container = DOMElements.systemChartsContainer;
            container.innerHTML = '';
            let itemsToDisplay = [];

            if (selectedView.type === 'all') {
                itemsToDisplay = Object.values(processedData.systemMap).map(system => ({
                    id: system.id, name: \`\${system.id} - \${system.name}\`,
                    data: _aggregateStatsForSystem(system.id, processedData.systemMap, processedData.subSystemMap)
                }));
            } else if (selectedView.type === 'system' && selectedView.id) {
                const system = processedData.systemMap[selectedView.id];
                if (system) itemsToDisplay = system.subs.map(subRef => ({
                    id: subRef.id, name: \`\${subRef.id} - \${processedData.subSystemMap[subRef.id]?.name || 'N/A'}\`,
                    data: _aggregateStatsForSubSystem(subRef.id, processedData.subSystemMap)
                }));
            } else if (selectedView.type === 'subsystem' && selectedView.id) {
                const subSystem = processedData.subSystemMap[selectedView.id];
                 if (subSystem) itemsToDisplay = [{ id: subSystem.id, name: \`\${subSystem.id} - \${subSystem.name}\`, data: _aggregateStatsForSubSystem(subSystem.id, processedData.subSystemMap) }];
            }
            itemsToDisplay = itemsToDisplay.filter(item => item.data.totalItems > 0);

            if (itemsToDisplay.length === 0) {
                container.innerHTML = \`<div class="col-span-full text-center py-10 text-slate-500" role="status">\${ICONS.PieChartIcon}<p class="mt-2">No systems/subsystems with data for this view.</p></div>\`; return;
            }
            
            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4';
            itemsToDisplay.forEach(item => {
                item.data.remaining = Math.max(0, item.data.totalItems - item.data.done - item.data.pending);
                const chartId = \`systemSubChart-\${item.id.replace(/[^a-zA-Z0-9]/g, '-')}\`;
                grid.innerHTML += \`
                    <div class="bg-slate-700/50 rounded-lg p-3 text-center">
                        <h6 class="text-slate-300 text-sm font-medium mb-1 truncate" title="\${item.name}">\${item.name}</h6>
                        <p class="text-slate-500 text-xs mb-2">\${item.data.totalItems.toLocaleString()} items</p>
                        <div class="chart-container" style="height: 200px;"><canvas id="\${chartId}" role="img"></canvas></div>
                    </div>\`;
                setTimeout(() => {
                    const canvas = document.getElementById(chartId);
                    if (!canvas) return;
                    if (item.data.totalItems > 0) {
                        chartInstances.systems[item.id] = new Chart(canvas.getContext('2d'), { type: 'doughnut', data: {
                            labels: ['Completed', 'Pending', 'Remaining'],
                            datasets: [{ label: item.name, data: [item.data.done, item.data.pending, item.data.remaining], backgroundColor: [COLORS_STATUS_CHARTJS.done, COLORS_STATUS_CHARTJS.pending, COLORS_STATUS_CHARTJS.remaining], borderWidth:0 }]
                        }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'bottom', labels: { color: '#9ca3af', boxWidth:10, font: {size: 10}} }, tooltip: { callbacks: { label: (c) => \`\${c.label}: \${c.formattedValue} (\${item.data.totalItems > 0 ? Math.round(c.parsed / item.data.totalItems * 100) : 0}%)\`}}} } });
                    } else {
                        canvas.parentElement.innerHTML = '<div class="h-full flex items-center justify-center text-slate-500 text-xs p-5">No data.</div>';
                    }
                }, 0);
            });
            container.appendChild(grid);
        }

        function renderDataTable() {
            const columns = [
                { header: 'System', accessor: 'system' }, { header: 'Subsystem', accessor: 'subsystem' },
                { header: 'Discipline', accessor: 'discipline' }, { header: 'Total Items', accessor: 'totalItems' },
                { header: 'Completed', accessor: 'completed' }, { header: 'Pending', accessor: 'pending' },
                { header: 'Punch', accessor: 'punch' }, { header: 'Hold Point', accessor: 'holdPoint' },
                { header: 'Status', accessor: 'statusPercent' },
            ];
            DOMElements.dataTableHead.innerHTML = \`<tr>\${columns.map(col => \`<th scope="col" class="px-4 py-3">\${col.header}</th>\`).join('')}</tr>\`;

            const tableData = _generateTableDataForView(selectedView, processedData, aggregatedStats.totalItems === 0);
            let bodyHTML = '';
            if (tableData.length === 0) {
                bodyHTML = \`<tr><td colspan="\${columns.length}" class="text-center py-10 text-slate-500">No data for current selection.</td></tr>\`;
            } else {
                tableData.forEach(row => {
                    let rowHtml = \`<tr class="border-b border-slate-700 hover:bg-slate-700/50" data-row-data='\${JSON.stringify({system: row.system, subsystem: \`\${row.subsystem} - \${row.subsystemName}\`, discipline: row.discipline})}'>\`;
                    columns.forEach((col, index) => {
                        let cellValue = row[col.accessor];
                        let cellClasses = 'px-4 py-2 clickable-cell';
                        let datasetAttrs = \`data-status-type="" data-context-type="table" data-data-type="items"\`;

                        if (col.accessor === 'statusPercent') {
                            const badgeColor = row.statusPercent > 80 ? 'bg-green-500/20 text-green-400' : row.statusPercent > 50 ? 'bg-sky-500/20 text-sky-400' : 'bg-amber-500/20 text-amber-400';
                            cellValue = \`<span class="px-2 py-0.5 text-xs font-medium rounded-full \${badgeColor}">\${row.statusPercent}%</span>\`;
                            datasetAttrs = \`data-status-type="OTHER" data-context-type="table" data-data-type="items"\`;
                        } else if (col.accessor === 'subsystem') {
                            cellValue = \`\${row.subsystem} - \${row.subsystemName}\`;
                        } else if (['totalItems', 'completed', 'pending', 'punch', 'holdPoint'].includes(col.accessor)) {
                            cellValue = (typeof cellValue === 'number') ? cellValue.toLocaleString() : cellValue;
                            if (col.accessor === 'totalItems') datasetAttrs = \`data-status-type="TOTAL" data-context-type="table" data-data-type="items"\`;
                            if (col.accessor === 'completed') datasetAttrs = \`data-status-type="DONE" data-context-type="table" data-data-type="items"\`;
                            if (col.accessor === 'pending') datasetAttrs = \`data-status-type="PENDING" data-context-type="table" data-data-type="items"\`;
                            if (col.accessor === 'punch') datasetAttrs = \`data-status-type="PUNCH" data-context-type="table" data-data-type="punch"\`;
                            if (col.accessor === 'holdPoint') datasetAttrs = \`data-status-type="HOLD" data-context-type="table" data-data-type="hold"\`;
                        } else {
                            cellClasses = 'px-4 py-2'; // Non-clickable cells
                            datasetAttrs = ''; 
                        }
                        
                        const cellTag = index === 0 ? \`<th scope="row" class="\${cellClasses} font-medium text-slate-200 whitespace-nowrap" \${datasetAttrs}>\${cellValue}</th>\` : \`<td class="\${cellClasses}" \${datasetAttrs}>\${cellValue}</td>\`;
                        rowHtml += cellTag;
                    });
                    rowHtml += '</tr>';
                    bodyHTML += rowHtml;
                });
            }
            DOMElements.dataTableBody.innerHTML = bodyHTML;
        }

        const _emptyStats = () => ({ totalItems: 0, done: 0, pending: 0, punch: 0, hold: 0, remaining: 0 });
        function _aggregateStatsForSubSystem(subSystemId, subSystemMap) {
            const subSystem = subSystemMap[subSystemId];
            if (!subSystem) return _emptyStats();
            return Object.values(subSystem.disciplines).reduce((acc, disc) => {
                acc.totalItems += disc.total; acc.done += disc.done; acc.pending += disc.pending;
                acc.punch += disc.punch; acc.hold += disc.hold; return acc;
            }, _emptyStats());
        }
        function _aggregateStatsForSystem(systemId, systemMap, subSystemMap) {
            const system = systemMap[systemId];
            if (!system) return _emptyStats();
            return system.subs.reduce((acc, subRef) => {
                const subStats = _aggregateStatsForSubSystem(subRef.id, subSystemMap);
                Object.keys(subStats).forEach(key => acc[key] += subStats[key]); return acc;
            }, _emptyStats());
        }
        function _aggregateStatsForAll(systemMap, subSystemMap) {
            return Object.keys(systemMap).reduce((acc, sysId) => {
                const sysStats = _aggregateStatsForSystem(sysId, systemMap, subSystemMap);
                Object.keys(sysStats).forEach(key => acc[key] += sysStats[key]); return acc;
            }, _emptyStats());
        }
        function _aggregateStatsForView(view, systemMap, subSystemMap) {
            let stats;
            if (view.type === 'all' || !view.id) stats = _aggregateStatsForAll(systemMap, subSystemMap);
            else if (view.type === 'system') stats = _aggregateStatsForSystem(view.id, systemMap, subSystemMap);
            else stats = _aggregateStatsForSubSystem(view.id, subSystemMap);
            stats.remaining = Math.max(0, stats.totalItems - stats.done - stats.pending);
            return stats;
        }
        function _generateTableDataForView(view, pData, isEmptyView, forExport = false) {
            const { systemMap, subSystemMap, allRawData } = pData;
            if (!forExport && isEmptyView && view.type !== 'all') return [];
            let relevantRawData = [];
            if (view.type === 'all') relevantRawData = allRawData;
            else if (view.type === 'system' && view.id) {
                const system = systemMap[view.id];
                if (system) relevantRawData = allRawData.filter(row => system.subs.some(s => s.id === row.SD_Sub_System?.trim()));
            } else if (view.type === 'subsystem' && view.id) {
                relevantRawData = allRawData.filter(row => row.SD_Sub_System?.trim() === view.id);
            }
            if (!forExport && relevantRawData.length === 0 && view.type !== 'all') return [];
            return relevantRawData.map(row => {
                const total = parseInt(row["TOTAL ITEM"]) || 0; const done = parseInt(row["TOTAL DONE"]) || 0;
                return {
                    system: row.SD_System?.trim(), systemName: (row.SD_System_Name || 'N/A').trim(),
                    subsystem: row.SD_Sub_System?.trim(), subsystemName: (row.SD_Subsystem_Name || 'N/A').trim(),
                    discipline: row.discipline?.trim(), totalItems: total, completed: done,
                    pending: parseInt(row["TOTAL PENDING"]) || 0, punch: parseInt(row["TOTAL NOT CLEAR PUNCH"]) || 0,
                    holdPoint: parseInt(row["TOTAL HOLD POINT"]) || 0, statusPercent: total > 0 ? Math.round((done / total) * 100) : 0,
                };
            });
        }

        function handleExport() {
            if (!processedData || !processedData.allRawData || processedData.allRawData.length === 0) {
                 alert("No data loaded to export."); return;
            }
            const dataToExportRaw = _generateTableDataForView(selectedView, processedData, false, true);
            if (dataToExportRaw.length === 0) { alert("No data for current selection to export."); return; }
            const dataToExport = dataToExportRaw.map(row => ({
                System: row.system, SystemName: row.systemName, SubSystem: row.subsystem, SubSystemName: row.subsystemName,
                Discipline: row.discipline, TotalItems: row.totalItems, Completed: row.completed, Pending: row.pending,
                Punch: row.punch, HoldPoint: row.holdPoint, ProgressPercent: \`\${row.statusPercent}%\`
            }));
            const viewName = selectedView.type === 'all' ? "AllSystems" : \`\${selectedView.type.charAt(0).toUpperCase() + selectedView.type.slice(1)}_\${selectedView.id.replace(/[^a-zA-Z0-9]/g, '_')}\`;
            const fileName = \`SAPRA_Report_\${viewName}_\${new Date().toISOString().split('T')[0]}.xlsx\`;
            try {
                const ws = XLSX.utils.json_to_sheet(dataToExport);
                const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'SAPRA Report');
                XLSX.writeFile(wb, fileName);
            } catch (e) { console.error("Error exporting:", e); alert("Error exporting to Excel."); }
        }
        function handleDetailsExport() {
            if (displayedItemsInModal.length === 0) { alert("No data in modal to export."); return; }
            let dataToExport = []; let sheetName = '';
            if (currentModalDataType === 'items') {
                dataToExport = displayedItemsInModal.map((item, i) => ({ '#': i + 1, Subsystem: item.subsystem, Discipline: item.discipline, TagNo: item.tagNo, TypeCode: item.typeCode, Description: item.description, Status: item.status }));
                sheetName = 'Item Details';
            } else if (currentModalDataType === 'punch') {
                dataToExport = displayedItemsInModal.map((item, i) => ({ '#': i + 1, Subsystem: item.subsystem, Discipline: item.discipline, TagNo: item.tagNo, TypeCode: item.typeCode || 'N/A', PunchCategory: item.punchCategory, PunchDescription: item.punchDescription }));
                sheetName = 'Punch Details';
            } else if (currentModalDataType === 'hold') {
                dataToExport = displayedItemsInModal.map((item, i) => ({ '#': i + 1, Subsystem: item.subsystem, Discipline: item.discipline, TagNo: item.tagNo, TypeCode: item.typeCode || 'N/A', HPPriority: item.hpPriority || 'N/A', HPDescription: item.hpDescription || 'N/A', HPLocation: item.hpLocation || 'N/A' }));
                sheetName = 'Hold Point Details';
            }
            if (dataToExport.length === 0) { alert("Failed to format data."); return; }
            const modalTitle = document.getElementById('itemDetailsModalLabel').textContent.replace(/[^a-zA-Z0-9 ]/g, '').replace(/ /g, '_');
            const fileName = \`SAPRA_Details_\${modalTitle || 'Items'}_\${new Date().toISOString().split('T')[0]}.xlsx\`;
            try {
                const ws = XLSX.utils.json_to_sheet(dataToExport);
                const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, sheetName);
                XLSX.writeFile(wb, fileName);
            } catch (e) { console.error("Error exporting modal details:", e); alert("Error exporting details to Excel."); }
        }
    </script>
</body>
</html>